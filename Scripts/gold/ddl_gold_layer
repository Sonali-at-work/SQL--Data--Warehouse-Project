/*
====================================================
DDL Create Gold views
====================================================
Script Purpose:
This script creates views for the gold layer in the data warehouse.
The gold layer represents the final dimensions and fact tables (Fact Constellation Schema).

Each view performs transformations and combines data from the silver layer to produce clean,
enriched and business ready dataset

Usage These views can be queired directly for analytics and reporting.

==============================================================================================
*/

--=================================================
           -- Dimension tables
--=================================================

-- avg(lat) and avg(long) -averaging them as there exist multiple entries in geolocation table for same zip code ,city and state causing granularity issue upon joining with the sellers dataset.
-- Then creating new physical table with the transformed rows.
-- This geolocation table will be used with seller table as join to obtain one dimension table.
-- Drop existing Gold table if it exists
IF OBJECT_ID('gold.olist_geolocation', 'U') IS NOT NULL
   DROP TABLE gold.olist_geolocation;
GO

-- Aggregate and create Gold table
SELECT 
    geolocation_zip_code_prefix,
    AVG(geolocation_lat) AS latitude,
    AVG(geolocation_lng) AS longitude,
    geolocation_city,
    geolocation_state
INTO gold.olist_geolocation
FROM silver.olist_geolocation   -- <--- read from Silver
GROUP BY geolocation_zip_code_prefix, geolocation_city, geolocation_state;
GO


IF OBJECT_ID('gold.dim_sellers','V') IS NOT NULL
   DROP View gold.dim_sellers
GO
create view gold.dim_sellers as
select 
    row_number() over(order by seller_id)as seller_key,
	s.seller_id,
	s.seller_zip_code_prefix,
	s.seller_city,
	s.seller_state,
	g.geolocation_zip_code_prefix,
	g.geolocation_city,
	g.geolocation_state,
	g.latitude,
	g.longitude
from silver.olist_sellers s left join silver.olist_geolocations g 
on s.seller_zip_code_prefix=g.geolocation_zip_code_prefix

Go
IF OBJECT_ID('gold.dim_products','V') IS NOT NULL
   DROP View gold.dim_products
GO
create view gold.dim_products as
select 
	row_number() over(order by product_id) as product_key,
	p.product_id,
	pc.product_category_name_english as product_category,
	p.product_name_lenght ,
	p.product_description_lenght,
	p.product_photos_qty as no_of_photos,
	p.product_weight_g as weight_in_gm,
	p.product_length_cm as length_in_cm,
	p.product_height_cm as height_in_cm,
	p.product_width_cm as width_in_cm
from silver.olist_products p left join silver.product_category_translation pc on
p.product_category_name=pc.product_category_name
GO

IF OBJECT_ID('gold.dim_customers','V') IS NOT NULL
   DROP View gold.dim_customers
GO
Create View gold.dim_customers as
select 
    row_number() over(order by customer_id)as customer_key,
	customer_id,
	customer_unique_id,
	customer_zip_code_prefix,
	customer_city,
	customer_state 
from silver.olist_customers

GO
--=============================================
           -- Fact tables --
--=============================================

--doing left join so as to not miss/loose data of the main table olist_orders
--rearranging column
--renaming them 
--create surrogate keys
IF OBJECT_ID('gold.fact_orders','v') IS NOT NULL
   DROP View gold.fact_orders
GO
Create view gold.fact_orders as
select 
	o.order_id,
	c.customer_key,
	o.order_status,
	o.order_purchase_timestamp,
	o.order_approved_at,
	o.order_delivered_carrier_date,
	o.order_delivered_customer_date,
	o.order_estimated_delivery_date,
	o.Flag_carrier_after_customer,
	o.diff_hours_carrier_to_customer,
	o.Flag_delivered_after_estimated,
	o.diff_hours_delivered_to_estimated,
	o.Overall_Flag_any_Delivery_Issue
from  silver.olist_orders o  left join  gold.dim_customers c
on o.customer_id=c.customer_id 

GO
IF OBJECT_ID('gold.fact_order_items','V') IS NOT NULL
   DROP View gold.fact_order_items
GO
create view gold.fact_order_items as
select 
oi.order_id,
oi.order_item_id,
p.product_key,
s.seller_key,
oi.shipping_limit_date,
oi.price,
oi.freight_value 
from silver.olist_order_items oi join gold.dim_products p on oi.product_id=p.product_id left
join gold.dim_sellers s on  oi.seller_id=s.seller_id

GO
IF OBJECT_ID('gold.fact_reviews','V') IS NOT NULL
   DROP View gold.fact_reviews
GO
Create view gold.fact_reviews as
select 
review_id,
order_id,
review_score as score,
review_comment_title as title,
review_comment_message as comment,
review_creation_date as creation_date,
review_answer_timestamp as aswer_timestamp
from silver.olist_order_reviews

GO
IF OBJECT_ID('gold.fact_payments','V') IS NOT NULL
   DROP View gold.fact_payments
GO
create view gold.fact_payments as
select
order_id,
payment_sequential,
payment_type as type,
payment_installments as installment,
payment_value as value
from silver.olist_order_payments
